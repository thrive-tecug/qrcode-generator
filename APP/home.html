<!DOCTYPE html>
<html>
    <head>
        <title>QRCode Generator Home Page</title>
    </head>

    <body>
        <h1>QRCode Code Generator</h1>
        <h3>Note that this is a local improvisional PAGE.</h3>
        
        <form id="mainform">
            <label for="url">BASE URL :</label>
            <input type="text" id="url" name="url" value='http://127.0.0.1:8000/' required><br>
            <label for="username">User name:</label>
            <input type="text" id="user" name="user" required="true"><br>
            <label for="count">How many QRCodes do you want?</label>
            <input type="number" id="count" name="count" min="1" value="1" required="true"><br>
            <label for="start">Starting from a value of </label>
            <input type="number" id="start" name="start" value="1" min="1" required="true"><br>
            <label for="length">Length of QRCode serial:</label>
            <input type="number" id="length" name="length" required><br>
            <label for="pre_string">Pre String : </label>
            <input type="text" id="pre_string" name="pre_string"><br>
            <label for="pro_string">Pro String : </label>
            <input type="text" id="pro_string" name="pro_string"><br>
            <label for="overwrite">Overwite Existing files? </label>
            <input type="checkbox" id="overwrite" name="overwrite" value="overwrite"><br>
            <input type="button" value="Submit" onclick="send_data()"/>
        </form>

        <br><br><br>
        <button onclick="onRequestSample()">See text samples</button>
        <div id="text_sample"></div> 
        <br><br>
        <button onclick="onCancelGeneration()">Cancel</button>
        <div id="cancel_button"></div> 
        <br><br>
        <button onclick="onRequestProgress()">Progress</button>
        <div id="progress_view"></div>
        <br>
        <h3>Downloads</h3>
        <button onclick="onRequestDownloads()">Get Downloads</button><br><br>
        <div id="downloadlist"></div>

        <script>
            var BASE_URL;

            var sampleField = document.getElementById('text_sample');
            sampleField.hidden = true;
            var progressView = document.getElementById('progress_view');
            var downloadList = document.getElementById('downloadlist');
            var cancelButton = document.getElementById('cancel_button');

            function getMainFormData(){
                var mainform = document.getElementById('mainform');
                var userfield = mainform.user.value;
                var countfield = mainform.count.value;
                var startfield = mainform.start.value;
                var lengthfield = mainform.length.value;
                var pre_stringfield = mainform.pre_string.value;
                var pro_stringfield = mainform.pro_string.value;
                var overwriteCheckbox = document.getElementById('overwrite');
                var overwritefield = overwriteCheckbox.checked;
                var urlfield = mainform.url.value;
                if (!urlfield.endsWith('/')){
                    urlfield = urlfield + '/';
                }
                return [userfield, countfield, startfield, lengthfield, 
                        pre_stringfield, pro_stringfield, overwritefield, urlfield];
            }

            function validateMainData(){
                var mainformdata = getMainFormData();
                var userfield = mainformdata[0];
                var countfield = mainformdata[1];
                var startfield = mainformdata[2];
                var lengthfield = mainformdata[3];
                var pre_stringfield = mainformdata[4];
                var pro_stringfield = mainformdata[5];
                var overwritefield = mainformdata[6];
                var urlfield = mainformdata[7];
                if (userfield == ''){ return false; }
                if (countfield == '' || countfield < 1){ return false; }
                if (startfield == '' || startfield < 1){ return false; }
                if (lengthfield == ''){ return false; }
                if(urlfield == ''){return false;}
                return true;   
            }

            async function test_url(){
                // checks if url is visible & gettable
                var formdata = getMainFormData();
                BASE_URL = '__NONE__';
                var url = formdata[7];
                try{
                    let response = fetch(url, {method:"GET"});
                    let res = await response;
                    BASE_URL = url;
                    console.log('URL ->', BASE_URL);
                }catch(err){
                    alert('Enter a valid BASE_URL; copy the current address in your browser and paste it in the base url field.');
                    throw(err);
                }
            }

            async function onCancelGeneration(){
                var valid = validateMainData();
                if (!valid){
                    alert('Please, Fill all required fields');
                    return;
                }
                var formdata = getMainFormData();
                var uservalue = formdata[0];
                await test_url();

                try{
                    let response = fetch( BASE_URL + 'cancel/'+uservalue, {method:'GET'});
                    let res = await response;
                    let result = await res.json();
                    console.log('Result :', result);
                    alert(result);
                }catch(err){
                    console.log(err);
                }

            }

            async function onRequestDownloads(){
                var valid = validateMainData();
                if (!valid){
                    alert('Please, Fill all required fields');
                    return;
                }
                var formdata = getMainFormData();
                var uservalue = formdata[0];
                await test_url();

                try{
                    let response = fetch( BASE_URL + 'downloads/'+uservalue, {method:'GET'});
                    let res = await response;
                    let arr = await res.json(); // returns a list
                    var liststring = '';
                    for (var i=0; i<arr.length; i++){
                        var s = '<a href='+BASE_URL+'download/'+arr[i][1]+'>'+
                            arr[i][0]+'<a><br>';
                        liststring += s;
                    }
                    downloadList.innerHTML = liststring;
                }catch(err){
                    console.log(err);
                }
            }

            async function onRequestProgress(){
                var valid = validateMainData();
                if (!valid){
                    alert('Please, Fill all required fields');
                    return;
                }
                var formdata = getMainFormData();
                var uservalue = formdata[0];
                await test_url();

                try{
                    let response = fetch( BASE_URL + 'progress/'+uservalue, {method:'GET'});
                    let res = await response;
                    let progress_data = await res.json();
                    progressView.innerHTML = progress_data[0].toString()+'/'+ progress_data[1].toString(); //.replace('\n', '<br>').replace('\n', '<br>');
                }catch(err){
                    console.log(err);
                }
            }
            
            async function onRequestSample(){
                var valid = validateMainData();
                if (!valid){
                    alert('Please, Fill all required fields');
                    return;
                }
                await test_url();
                
                var mainformdata = getMainFormData();
                var uservalue = mainformdata[0];
                var countvalue = mainformdata[1];
                var startvalue = mainformdata[2];
                var lengthvalue = mainformdata[3];
                var pre_stringvalue = mainformdata[4];
                var pro_stringvalue = mainformdata[5];
                var overwritevalue = mainformdata[6];

                var jsondata = {"user":uservalue, 
                                "count":countvalue, 
                                "start":startvalue, 
                                "length":lengthvalue,
                                "pre_string":pre_stringvalue,
                                "pro_string":pro_stringvalue,
                                "overwrite":overwritevalue
                            };
                
                try{
                    let response = fetch(
                        BASE_URL + 'stringsample/', 
                        {method:'POST', body:JSON.stringify(jsondata),
                        headers: { "Content-type": "application/json; charset=UTF-8" }
                    });
                    let res = await response;
                    let result = await res.json();
                    sampleField.hidden = false;
                    sampleField.innerHTML = result; //.replace('\n', '<br>').replace('\n', '<br>');
                }catch(err){
                    console.log(err);
                }
            }

            async function send_data(){
                var valid = validateMainData();
                if (!valid){
                    alert('Please, Fill all required fields');
                    return;
                }
                await test_url();

                var mainformdata = getMainFormData();
                var uservalue = mainformdata[0];
                var countvalue = mainformdata[1];
                var startvalue = mainformdata[2];
                var lengthvalue = mainformdata[3];
                var pre_stringvalue = mainformdata[4];
                var pro_stringvalue = mainformdata[5];
                var overwritevalue = mainformdata[6];

                var jsondata = {"user":uservalue, 
                                "count":countvalue, 
                                "start":startvalue, 
                                "length":lengthvalue,
                                "pre_string":pre_stringvalue,
                                "pro_string":pro_stringvalue,
                                "overwrite":overwritevalue
                            };
                
                try{
                    let response = fetch(
                        BASE_URL + 'generate/', 
                        {method:'POST', body:JSON.stringify(jsondata),
                        headers: { "Content-type": "application/json; charset=UTF-8" }
                    });
                    let res = await response;
                    let result = await res.json();
                    console.log('Result :', result);
                    alert(result);
                }catch(err){
                    console.log(err);
                }
            }
        </script>
    </body>

</html>